#!/bin/bash

# few functions with set of commands to be run in specific moments
# during arch linux install
# 
# Usage
#
# BTW_ROOT=/dev/nvme0n1p7 BTW_SWAP=/dev/nvme0n1p6 BTW_EFI=/dev/nvme0n1p1 archlinux
#
# after running from usb, run first 

echo running as $(whoami)
fdisk -l 
echo root $BTW_ROOT
echo swap $BTW_SWAP
echo efi $BTW_EFI

function btw-first-run-from-live () {
  echo Setting keyboard 
  loadkeys plugins
  setfont ter-132b
  echo Verifying boot mode...
  cat /sys/firmware/efi/fw_platform_size
  echo Checking internet...
  ip link
  ping -c 5 archlinux.org
  timedatectl

  echo Wiping disks
  mkfs.ext4 $BTW_ROOT
  mkswap $BTW_SWAP

  echo Mounting drives...
  mount $BTW_ROOT /mnt
  mount $BTW_EFI --mkdir /mnt/boot
  swapon $BTW_SWAP

  pacstrap -K /mnt base base-devel linux linux-firmware vim networkmanager zsh git
  genfstab -U /mnt >> /mnt/etc/fstab
  # edit locale files
  arch-chroot /mnt ln -sf /usr/share/zoneinfo/Region/City /etc/localtime
  arch-chroot /mnt hwclock --systohc
  arch-chroot /mnt locale-gen
  arch-chroot /mnt cat "archforce" >> /etc/hostname
  arch-chroot /mnt passwd
  arch-chroot /mnt grub-mkconfig -o /boot/grub/grub.cfg
  arch-chroot /mnt grub-install --target=x86_64.efi --efi-directory=/boot --bootloader-id=GRUB
}

# After restarting inside new system
function btw-root-setup () {
  # run as root
  # add user
  useradd --create-home mrkosmici
  usermod -aG wheel mrkosmici

  # install yay AUR helper
  git clone https://aur.archlinux.org/yay-bin.git
  cd yay-bin
  makepkg -si
  rm -r yay-bin
  btw-install-software
  sudo -Hu mrkosmici btw-user-setup
  sudo -Hu mrkosmici gh auth login
  sudo -Hu mrkosmici btw-run-after-gh
}

function btw-user-setup () {
  # install ohmyzsh
  sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
  # change theme to powerlevel10k
  git clone --depth=1 https://github.com/romkatv/powerlevel10k.git ${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/themes/powerlevel10k
  sed -i 's/ZSH_THEME="robbyrussell"/ZSH_THEME="powerlevel10k\/powerlevel10k"/' ~/.zshrc
  # Install Oh My Zsh plugins
  git clone --depth=1 https://github.com/romkatv/zsh-prompt-benchmark.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-prompt-benchmark
  git clone --depth=1 https://github.com/olets/zsh-abbr.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-abbr
  git clone --depth=1 https://github.com/zsh-users/zsh-autosuggestions.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions
  git clone --depth=1 https://github.com/zsh-users/zsh-syntax-highlighting.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting
}

function btw-install-software () {
  yay -S acpi adwaita-qt5-git adwaita-qt6-git aisleriot alacritty alacritty-theme alacritty-themes android-tools atlauncher base base-devel bluez bluez-utils brightnessctl chromium clockify-cli-bin clockify-desktop cmatrix cmus conky cowsay debtap dmenu dmidecode dnsmasq efibootmgr exfatprogs fd feh firefox fzf gimp git github-cli gnome-keyring gnome-themes-extra gparted grub gtypist heroku-cli-bin htop hwinfo i3-wm i3blocks i3lock i3status ipython jq keepass lib32-mesa lib32-vulkan-icd-loader lib32-vulkan-intel libhandy libreoffice-fresh linux linux-firmware lsd lutris maim man-db man-pages minecraft-launcher montserrat-otf mpv neofetch neovim networkmanager ngrok nodejs npm ntfs-3g obs-studio obsidian octopi openssh otf-raleway p7zip pacman-contrib pandoc-bin pcmanfm pipewire pipewire-pulse pixiecore-git prettyping pv pwgen pyenv python-poetry rclone reaper rsync scrcpy scribus scrot signal-desktop sl speedtest-cli sshfs sudo telegram-desktop testdisk texlive-binextra texlive-langpolish texlive-latex tldr tmux toilet translate-shell transmission-gtk tree ttf-dejavu ttf-hack-nerd ttf-meslo-nerd unzip veracrypt vim vulkan-intel wget wine xcape xclip xdotool xorg-server xorg-xclock xorg-xev xorg-xinit xorg-xinput xorg-xrandr xss-lock xterm yarn yay-bin yewtube-git yt-dlp zip zsh
}

function btw-run-after-gh () {
  mkdir $HOME/reps
  mkdir $HOME/bin
  cd $HOME/reps
  gh repo clone scripts
  gh repo clone dotfiles
  cd $HOME/reps/dotfiles
  git switch arch-t480s
  chmod +x $HOME/reps/dotfiles/install
  $HOME/reps/dotfiles/install
  ln -s /home/mrkosmici/reps/scripts/add_daily_note.sh /home/mrkosmici/bin/daily
  ln -s /home/mrkosmici/reps/scripts/conky-i3bar /home/mrkosmici/bin/conky-i3bar
  ln -s /home/mrkosmici/reps/scripts/set-theme /home/mrkosmici/bin/set-theme
  ln -s /home/mrkosmici/reps/scripts/toggler.sh /home/mrkosmici/bin/toggler
  ln -s /home/mrkosmici/reps/scripts/volumelimiter /home/mrkosmici/bin/volumelimiter
}
