#!/bin/zsh

# few functions with set of commands to be run in specific moments
# during arch linux install
# 
# Usage
#
# BTW_ROOT=/dev/nvme0n1p7 BTW_SWAP=/dev/nvme0n1p6 BTW_EFI=/dev/nvme0n1p1 archlinux

echorun() {
  echo "[$(date '+%Y-%m-%d %H:%M:%S')] run: $@"
  "$@"
}

packages =  (
  acpi
  aisleriot
  alacritty
  android-tools
  base
  base-devel
  bluez
  bluez-utils
  brightnessctl
  chromium
  cmatrix
  cmus
  conky
  cowsay
  dmenu
  dmidecode
  dnsmasq
  exfatprogs
  fd
  feh
  firefox
  fzf
  gimp
  git
  github-cli
  gnome-keyring
  gnome-themes-extra
  gparted
  htop
  hwinfo
  i3-wm
  i3blocks
  i3lock
  i3status
  ipython
  jq
  keepass
  libhandy
  libreoffice-fresh
  linux
  linux-firmware
  lsd
  lutris
  maim
  man-db
  man-pages
  mpv
  neofetch
  neovim
  networkmanager
  nodejs
  npm
  ntfs-3g
  obs-studio
  obsidian
  openssh
  p7zip
  pacman-contrib
  pcmanfm
  pipewire
  pipewire-pulse
  prettyping
  pv
  pwgen
  pyenv
  python-poetry
  rclone
  reaper
  rsync
  scrcpy
  scribus
  scrot
  signal-desktop
  sl
  speedtest-cli
  sshfs
  sudo
  telegram-desktop
  testdisk
  texlive-binextra
  texlive-langpolish
  texlive-latex
  tldr
  tmux
  toilet
  translate-shell
  transmission-gtk
  tree
  ttf-dejavu
  ttf-hack-nerd
  ttf-meslo-nerd
  unzip
  veracrypt
  vim
  vulkan-intel
  wget
  wine
  xcape
  xclip
  xdotool
  xorg-server
  xorg-xclock
  xorg-xev
  xorg-xinit
  xorg-xinput
  xorg-xrandr
  xss-lock
  xterm
  yarn
  yt-dlp
  zip
  zsh
)


aurpackages = (
  alacritty-theme
  alacritty-themes
  atlauncher
  clockify-cli-bin
  clockify-desktop
  debtap
  gtypist
  heroku-cli-bin
  minecraft-launcher
  montserrat-otf
  ngrok
  octopi
  otf-raleway
  pandoc-bin
  pixiecore-git
  python-backcall
  python-pafy-git
  vtop
  woeusb
  yay-bin
  yewtube-git
  youtube-dl
  youtube-search-python-git
)

checkroot() {
  echo "Checking root..."
  (( EUID == 0 )) || die 'need root privileges'
}

btw-presetup () { 
  # This should be started first
  checkroot
  echorun loadkeys pl
  echo "Verifying boot mode..."
  echorun cat /sys/firmware/efi/fw_platform_size
  echo "Checking internet..."
  echorun ip link
  echorun ping -c 1 archlinux.org
  echorun timedatectl

  echo "Ok, I will format disks"
  echo root: $BTW_ROOT
  echo swap: $BTW_SWAP
  echo efi: $BTW_EFI

  echo "Formatting disks..."
  echorun mkfs.ext4 $BTW_ROOT
  echorun mkswap $BTW_SWAP
  echo "Formatted"

  echo "Mounting drives..."
  echorun mount $BTW_ROOT /mnt
  echorun mount $BTW_EFI --mkdir /mnt/boot
  echorun swapon $BTW_SWAP
  echorun pacstrap -K /mnt base base-devel linux linux-firmware vim networkmanager zsh git grub efibootmgr
  echorun genfstab -U /mnt >> /mnt/etc/fstab
  echorun genfstab -U /mnt

  # turn on color in pacman
  echorun sed -i 's/^#\(Color\)/\1/' /mnt/etc/pacman.conf
}

btw-chroot-root () {
  checkroot
  cat <<EOF > /mnt/root/run-as-root
  ln -sf /usr/share/zoneinfo/Europe/Warsaw /etc/localtime
  hwclock --systohc
  locale-gen
  echo set hostname to archforce
  echo archforce >> /etc/hostname
  echo new root password
  systemctl enable NetworkManager
  grub-mkconfig -o /boot/grub/grub.cfg
  grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=GRUB
  # add user
  useradd --create-home mrkosmici
  usermod -aG wheel mrkosmici
EOF
  echorun arch-chroot /mnt bash /root/run-as-root
}

btw-chroot-user() {
  cat <<EOF > /mnt/home/mrkosmici/run-as-user
  git clone https://aur.archlinux.org/yay-bin.git
  cd yay-bin
  makepkg -si
  rm -r ../yay-bin

  # install ohmyzsh
  sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
  # change theme to powerlevel10k
  git clone --depth=1 https://github.com/romkatv/powerlevel10k.git ${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/themes/powerlevel10k
  sed -i 's/ZSH_THEME="robbyrussell"/ZSH_THEME="powerlevel10k\/powerlevel10k"/' ~/.zshrc
  # Install Oh My Zsh plugins
  git clone --depth=1 https://github.com/romkatv/zsh-prompt-benchmark.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-prompt-benchmark
  git clone --depth=1 https://github.com/olets/zsh-abbr.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-abbr
  git clone --depth=1 https://github.com/zsh-users/zsh-autosuggestions.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions
  git clone --depth=1 https://github.com/zsh-users/zsh-syntax-highlighting.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting
EOF
  echorun arch-chroot -u mrkosmici /mnt bash /home/mrkosmici/run-as-user
}

makecapslockgreatagain() {
  cat <<EOF > /usr/share/X11/xkb/symbols/pl_caps
partial alphanumeric_keys

xkb_symbols "hjkl" {
    // make capslock a level5 shift modifier
    include "level5(caps_switch)"

    // Make the following keys capable of using eight levels.
    key.type[Group1] = "EIGHT_LEVEL";

    key <AD07>	{ [ NoSymbol, NoSymbol, NoSymbol, NoSymbol, Prior, Prior ]	};
    key <AD08>	{ [ NoSymbol, NoSymbol, NoSymbol, NoSymbol, Home, Home ]	};
    key <AD09>	{ [ NoSymbol, NoSymbol, NoSymbol, NoSymbol, End, End ]	};
    key <AD10>	{ [ NoSymbol, NoSymbol, NoSymbol, NoSymbol, Next, Next ]	};

    // caps + hjkl
    key <AC06> { [ NoSymbol, NoSymbol, NoSymbol, NoSymbol, Left, Left ] };
    key <AC07> { [ NoSymbol, NoSymbol, NoSymbol, NoSymbol, Down, Down ] };
    key <AC08> { [ NoSymbol, NoSymbol, NoSymbol, NoSymbol, Up, Up ] };
    key <AC09> { [ NoSymbol, NoSymbol, NoSymbol, NoSymbol, Right, Right ] };
};

xkb_symbols "x220" {
    key <LSGT>  { [ Insert, Insert, Insert, Insert ] };
};
EOF
}

btw-install () { pacstrap /mnt ${packages[@]} }
btw-install-aur() { arch-chroot -u mrkosmici /mnt bash yay -S --noconfirm "${aurpackages[@]}" }

btw-install-games () { yay -S atlauncher minecraft-launcher lutris lib32-mesa lib32-vulkan-icd-loader lib32-vulkan-intel }
btw-install-media () { yay -S reaper gimp scribus }

btw-setup-after-gh () {
  arch-chroot -u mrkosmici /mnt bash -c <<EOF
  mkdir $HOME/reps
  mkdir $HOME/bin
  cd $HOME/reps
  gh repo clone scripts
  gh repo clone dotfiles
  cd $HOME/reps/dotfiles
  git switch arch-t480s
  chmod +x $HOME/reps/dotfiles/install
  $HOME/reps/dotfiles/install
  ln -s /home/mrkosmici/reps/scripts/add_daily_note.sh /home/mrkosmici/bin/daily
  ln -s /home/mrkosmici/reps/scripts/conky-i3bar /home/mrkosmici/bin/conky-i3bar
  ln -s /home/mrkosmici/reps/scripts/set-theme /home/mrkosmici/bin/set-theme
  ln -s /home/mrkosmici/reps/scripts/toggler.sh /home/mrkosmici/bin/toggler
  ln -s /home/mrkosmici/reps/scripts/volumelimiter /home/mrkosmici/bin/volumelimiter
EOF
}

echo running as $(whoami)
echorun fdisk -l 
echo root $BTW_ROOT
echo swap $BTW_SWAP
echo efi $BTW_EFI

usage()  {

  cat <<-EOF
Usage

you should call:

btw-presetup
btw-chroot-root
btw-chroot-user
btw-install
btw-install-aur
arch-chroot -u mrkosmici /mnt bash "gh auth login"
btw-setup-after-gh
EOF
}

usage

echorun btw-presetup
echorun btw-chroot-root
echorun btw-chroot-user
echorun makecapslockgreatagain
echorun btw-install
echorun btw-install-aur
arch-chroot -u mrkosmici /mnt bash "gh auth login"
echorun btw-setup-after-gh

  # sudo -Hu mrkosmici btw-user-setup
  # sudo -Hu mrkosmici gh auth login
  # sudo -Hu mrkosmici btw-run-after-gh
