#!/bin/bash

# few functions with set of commands to be run in specific moments
# during arch linux install
# 
# Usage
#
# BTW_ROOT=/dev/nvme0n1p7 BTW_SWAP=/dev/nvme0n1p6 BTW_EFI=/dev/nvme0n1p1 archlinux


checkroot() {
  (( EUID == 0 )) || die 'need root privileges'
}

btw-presetup () { 
  # This should be started first
  checkroot
  echo Setting keyboard to pl
  loadkeys pl
  echo Verifying boot mode...
  cat /sys/firmware/efi/fw_platform_size
  echo Checking internet...
  ip link
  ping -c 3 archlinux.org
  timedatectl

  echo Ok, I will format disks
  echo root: $BTW_ROOT
  echo swap: $BTW_SWAP
  echo efi:  $BTW_EFI
  echo ok?
  read -n 1 -s -r -p "Press any key to continue"

  echo Formatting disks...
  mkfs.ext4 $BTW_ROOT
  mkswap $BTW_SWAP
  echo Formatted

  echo Mounting drives...
  mount $BTW_ROOT /mnt
  mount $BTW_EFI --mkdir /mnt/boot
  swapon $BTW_SWAP

  echo going to
  echo pacstrap -K /mnt base base-devel linux linux-firmware vim networkmanager zsh git
  read -n 1 -s -r -p "Press any key to continue"

  pacstrap -K /mnt base base-devel linux linux-firmware vim networkmanager zsh git
  genfstab -U /mnt >> /mnt/etc/fstab
  echo "genfstab -U /mnt"
  genfstab -U /mnt
  read -n 1 -s -r -p "Press any key to continue"

  # turn on color in pacman
  sed -i 's/^#\(Color\)/\1/' /mnt/etc/pacman.conf
}

btw-chroot-root () {
  checkroot
  arch-chroot /mnt bash <<-EOF
  ln -sf /usr/share/zoneinfo/Europe/Warsaw /etc/localtime
  hwclock --systohc
  locale-gen
  echo archforce >> /etc/hostname
  passwd
  systemctl enable NetworkManager
  grub-mkconfig -o /boot/grub/grub.cfg
  grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=GRUB
  # add user
  useradd --create-home mrkosmici
  usermod -aG wheel mrkosmici
  passwd mrkosmici

  # install yay AUR helper
  # btw-install-software
  # sudo -Hu mrkosmici btw-user-setup
  # sudo -Hu mrkosmici gh auth login
  # sudo -Hu mrkosmici btw-run-after-gh
  EOF
}

btw-chroot-user() {
  arch-chroot -u mrkosmici /mnt bash <<-EOF
  git clone https://aur.archlinux.org/yay-bin.git
  cd yay-bin
  makepkg -si
  rm -r ../yay-bin

  # install ohmyzsh
  sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
  # change theme to powerlevel10k
  git clone --depth=1 https://github.com/romkatv/powerlevel10k.git ${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/themes/powerlevel10k
  sed -i 's/ZSH_THEME="robbyrussell"/ZSH_THEME="powerlevel10k\/powerlevel10k"/' ~/.zshrc
  # Install Oh My Zsh plugins
  git clone --depth=1 https://github.com/romkatv/zsh-prompt-benchmark.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-prompt-benchmark
  git clone --depth=1 https://github.com/olets/zsh-abbr.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-abbr
  git clone --depth=1 https://github.com/zsh-users/zsh-autosuggestions.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions
  git clone --depth=1 https://github.com/zsh-users/zsh-syntax-highlighting.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting
  EOF
}

makecapslockgreatagain() {
  cat <<EOF > /usr/share/X11/xkb/symbols/pl_caps
partial alphanumeric_keys

xkb_symbols "hjkl" {
    // make capslock a level5 shift modifier
    include "level5(caps_switch)"

    // Make the following keys capable of using eight levels.
    key.type[Group1] = "EIGHT_LEVEL";

    key <AD07>	{ [ NoSymbol, NoSymbol, NoSymbol, NoSymbol, Prior, Prior ]	};
    key <AD08>	{ [ NoSymbol, NoSymbol, NoSymbol, NoSymbol, Home, Home ]	};
    key <AD09>	{ [ NoSymbol, NoSymbol, NoSymbol, NoSymbol, End, End ]	};
    key <AD10>	{ [ NoSymbol, NoSymbol, NoSymbol, NoSymbol, Next, Next ]	};

    // caps + hjkl
    key <AC06> { [ NoSymbol, NoSymbol, NoSymbol, NoSymbol, Left, Left ] };
    key <AC07> { [ NoSymbol, NoSymbol, NoSymbol, NoSymbol, Down, Down ] };
    key <AC08> { [ NoSymbol, NoSymbol, NoSymbol, NoSymbol, Up, Up ] };
    key <AC09> { [ NoSymbol, NoSymbol, NoSymbol, NoSymbol, Right, Right ] };
};

xkb_symbols "x220" {
    key <LSGT>  { [ Insert, Insert, Insert, Insert ] };
};
EOF
}

function btw-yay-install-software () {
  arch-chroot -u mrkosmici /mnt bash "yay -S acpi adwaita-qt5-git adwaita-qt6-git aisleriot alacritty alacritty-theme alacritty-themes android-tools base base-devel bluez bluez-utils brightnessctl chromium clockify-cli-bin clockify-desktop cmatrix cmus conky cowsay debtap dmenu dmidecode dnsmasq efibootmgr exfatprogs fd feh firefox fzf git github-cli gnome-keyring gnome-themes-extra gparted grub gtypist heroku-cli-bin htop hwinfo i3-wm i3blocks i3lock i3status ipython jq keepass libhandy libreoffice-fresh lsd maim man-db man-pages montserrat-otf mpv neofetch neovim networkmanager ngrok nodejs npm ntfs-3g obs-studio obsidian openssh otf-raleway p7zip pacman-contrib pandoc-bin pcmanfm pipewire pipewire-pulse pixiecore-git prettyping pv pwgen pyenv python-poetry rclone rsync scrcpy scribus scrot signal-desktop sl speedtest-cli sshfs sudo telegram-desktop testdisk texlive-binextra texlive-langpolish texlive-latex tldr tmux toilet translate-shell transmission-gtk tree ttf-dejavu ttf-hack-nerd ttf-meslo-nerd unzip veracrypt vim vulkan-intel wget wine xcape xclip xdotool xorg-server xorg-xclock xorg-xev xorg-xinit xorg-xinput xorg-xrandr xss-lock xterm yarn yay-bin yewtube-git yt-dlp zip zsh"
}

function btw-install-games () {
  yay -S atlauncher minecraft-launcher lutris lib32-mesa lib32-vulkan-icd-loader lib32-vulkan-intel
}

function btw-install-media () {
  yay -S reaper gimp scribus
}

btw-setup-after-gh () {
  mkdir $HOME/reps
  mkdir $HOME/bin
  cd $HOME/reps
  gh repo clone scripts
  gh repo clone dotfiles
  cd $HOME/reps/dotfiles
  git switch arch-t480s
  chmod +x $HOME/reps/dotfiles/install
  $HOME/reps/dotfiles/install
  ln -s /home/mrkosmici/reps/scripts/add_daily_note.sh /home/mrkosmici/bin/daily
  ln -s /home/mrkosmici/reps/scripts/conky-i3bar /home/mrkosmici/bin/conky-i3bar
  ln -s /home/mrkosmici/reps/scripts/set-theme /home/mrkosmici/bin/set-theme
  ln -s /home/mrkosmici/reps/scripts/toggler.sh /home/mrkosmici/bin/toggler
  ln -s /home/mrkosmici/reps/scripts/volumelimiter /home/mrkosmici/bin/volumelimiter
}


echo running as $(whoami)
fdisk -l 
echo root $BTW_ROOT
echo swap $BTW_SWAP
echo efi $BTW_EFI

btw-presetup
echo next I will run btw-chroot-root
read -n 1 -s -r -p "Press any key to continue"
btw-chroot-root
echo next I will run btw-chroot-user 
read -n 1 -s -r -p "Press any key to continue"
btw-chroot-user
echo next I will run btw-yay-install-software
read -n 1 -s -r -p "Press any key to continue"
btw-yay-install-software
echo "next I will chroot again"
read -n 1 -s -r -p "Press any key to continue"
arch-chroot -u mrkosmici /mnt bash "gh auth login"
echo "gh working?"
read -n 1 -s -r -p "Press any key to continue"
btw-setup-after-gh
